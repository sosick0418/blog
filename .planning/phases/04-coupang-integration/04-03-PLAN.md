---
phase: 04-coupang-integration
plan: 03
type: execute
depends_on: ["04-01"]
files_modified: [src/_data/coupang/affiliate.js, scripts/generate-post.js, package.json]
---

<objective>
Implement affiliate link generation with tracking and create post generation utility.

Purpose: Complete the Coupang integration by enabling affiliate link creation with proper tracking and automating the generation of markdown post files from product data.
Output: Working affiliate link generator and CLI script to create blog posts from Coupang products.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-coupang-integration/04-01-SUMMARY.md
@.planning/phases/04-coupang-integration/DISCOVERY.md
@src/_data/coupang/index.js
@src/_data/coupang/config.js
@src/posts/sample-product-review.md

**Tech stack available:** 11ty, Node.js
**Established patterns:**
- Posts in `src/posts/` with frontmatter schema
- posts.json provides default layout and tags
- Category filtering via `category` frontmatter

**From 04-01:**
- Affiliate link structure documented in DISCOVERY.md
- Partner ID configuration established
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement affiliate link generator</name>
  <files>src/_data/coupang/affiliate.js</files>
  <action>
Create affiliate link generator module:

Function: `generateAffiliateLink(productId, options)`

Based on DISCOVERY.md findings, implement link generation:

**Standard Coupang Partners format:**
```
https://link.coupang.com/a/XXXXXX?itemId={productId}&vendorItemId={vendorId}
```

Or Deep Link format:
```
https://www.coupang.com/vp/products/{productId}?sourceType=srp&vendorItemId={vendorId}&is498=true&ctag={trackingTag}
```

Parameters to include:
- Partner tracking ID (from config/environment)
- Product ID
- Optional: campaign tracking (utm parameters)
- Sub-tracking ID for analytics

Export:
- `generateAffiliateLink(productId, options)` - returns complete affiliate URL
- `parseProductUrl(url)` - extracts productId from Coupang URL (utility for manual entry)

Handle edge cases:
- Missing partner ID → return direct product URL with warning
- Invalid product ID → throw descriptive error
  </action>
  <verify>node -e "const a = require('./src/_data/coupang/affiliate'); console.log(a.generateAffiliateLink('12345'))"</verify>
  <done>generateAffiliateLink returns properly formatted affiliate URL with tracking parameters</done>
</task>

<task type="auto">
  <name>Task 2: Create post generation script</name>
  <files>scripts/generate-post.js, package.json</files>
  <action>
Create CLI script to generate markdown post files from product data:

`scripts/generate-post.js`:

Usage: `node scripts/generate-post.js --product <productId>`
       `node scripts/generate-post.js --file <products.json>`

Script should:
1. Load product data (from products.json or by ID)
2. Transform using coupang module functions
3. Generate frontmatter YAML
4. Create placeholder content structure (for LLM to fill in Phase 5)
5. Write to `src/posts/{slug}.md`

Output file structure:
```markdown
---
title: "{product.name} 리뷰"
description: "{product.name} 상세 리뷰 및 구매 가이드"
date: {current date}
category: {category}
product:
  name: "{name}"
  price: {price}
  rating: 4
  affiliateLink: "{generated link}"
  image: "{imageUrl}"
---

<!-- LLM content placeholder -->
## 제품 소개

[AI가 작성할 제품 소개 섹션]

## 장점

[AI가 작성할 장점 섹션]

## 단점

[AI가 작성할 단점 섹션]

## 구매 추천

[AI가 작성할 구매 추천 섹션]
```

Add npm script to package.json:
```json
"generate:post": "node scripts/generate-post.js"
```

Use slugify for filename (Korean to safe filename).
Check if file exists before overwriting (--force flag to override).
  </action>
  <verify>node scripts/generate-post.js --help || echo "Script created"</verify>
  <done>Script generates valid markdown file with correct frontmatter, npm script added</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `src/_data/coupang/affiliate.js` exports generateAffiliateLink
- [ ] Affiliate link includes partner tracking ID
- [ ] `scripts/generate-post.js` creates valid markdown files
- [ ] Generated post builds successfully with 11ty
- [ ] `npm run generate:post` script works
- [ ] `npm run build` succeeds with generated posts
</verification>

<success_criteria>

- Affiliate links include proper tracking
- Post generation script creates valid markdown
- Generated posts render correctly in 11ty
- Phase 4 complete: Coupang integration functional
</success_criteria>

<output>
After completion, create `.planning/phases/04-coupang-integration/04-03-SUMMARY.md`
</output>
